<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Teste nave - Canvas HTML5</title>
        <script src="js/animacao.js"></script>
        <script src="js/teclado.js"></script>
        <script src="js/colisor.js"></script>
        <script src="js/spritesheet.js"></script>
        <script src="js/fundo.js"></script>
        <script src="js/nave.js"></script>
        <script src="js/ovni.js"></script>
        <script src="js/tiro.js"></script>
        <script src="js/explosao.js"></script>
        <link rel="stylesheet" href="css/style.css">
    </head>
    <body>
        <canvas id="palco" width="500" height="500">
            Ops! O seu navegador parece não ter suporte para este recurso.. :(
        </canvas>
        <a id="link_jogar" href="javascript: iniciarJogo()">JOGAR</a>
        <script>
            // Encontra o canvas e o contexo 2D
            var canvas = document.getElementById('palco');
            var context = canvas.getContext('2d');
            
            
            // Variáveis principais
            var imagens, animacao, teclado, colisor, nave, criadorInimigos;
            var totalImagens = 0, carregadas = 0;
            var musicaFundo;
            
            // Chamamos a função que carrega as imagens
            carregarImagens();
            
            // Chamamos a função que carrega as musicas de fundo
            carregarMusicas();
            
            // Função que realiza o carregamento das imagens
            function carregarImagens() {
                // Criamos um objeto, associando o nome ao arquivo de imagem                
                imagens = {
                    espaco: 'fundo-espaco.png',
                    estrelas: 'fundo-estrelas.png',
                    nuvens: 'fundo-nuvens.png',
                    nave: 'nave-spritesheet.png',
                    ovni: 'ovni.png',
                    explosao: 'explosao.png'
                };
                
                // Carrega todas as imagens
                for (var i in imagens) {
                    // Cria um objeto imagem
                    var img = new Image();
                    // Define a imagem que será carregada
                    img.src = 'assets/images/' + imagens[i];
                    // Setamos a função carregando para após o carregamento da imagem
                    img.onload = carregando;
                    // Incrementamos a quantidade total de imagens
                    totalImagens++;
                    
                    // Substituimos o caminho da imagem, com o objeto de imagem
                    imagens[i] = img;
                }
            }
            
            
            // Função que monitora o carregamento das imagens e inicia o jogo
            function carregando(){
                // Salva as configurações do contexto para não perdermos elas
                context.save();
                
                // Colocamos uma imagem de fundo
                context.drawImage(imagens.espaco, 0, 0, canvas.width, canvas.height);
                
                //context.translate(0.5, 0.5);
                
                // Colocamos o texto "Carregando"
                context.fillStyle = 'white';
                context.strokeStyle = 'black';
                context.font = '40px serif';
                context.fillText("CARREGANDO", 110, 250);
                
                // Incrementamos a variável de itens carregados
                carregadas++;
                
                // Desenhamos a barra de loading
                var tamanhoTotal = 300;
                var tamanho = carregadas / totalImagens * tamanhoTotal;
                
                // Desenhamos a barrinha vazia
                context.fillStyle = 'black';
                context.fillRect(99.5, 259.5, tamanhoTotal, 4);
                context.strokeStyle = 'white';
                context.lineWidth = 1;
                context.strokeRect(99.5, 259.5, tamanhoTotal, 4);
                
                context.fillStyle = 'white';
                context.fillRect(99.5, 259.5, tamanho, 4);
                
                // Restaura as configurações do contexto
                context.restore();
                
                // Com as imagens carregadas, mostramos o botão jogar
                if (carregadas == totalImagens) {
                    iniciarObjetos();
                    mostrarLinkJogar();
                }
            }
            
            // Função responsável por iniciar os principais objetos do jogo
            function iniciarObjetos() {
                // Objetos principais
                animacao = new Animacao(context);
                teclado = new Teclado(document);
                colisor = new Colisor();
                
                // Inicia as imagens
                espaco = new Fundo(context, imagens.espaco);
                estrelas = new Fundo(context, imagens.estrelas);
                nuvens = new Fundo(context, imagens.nuvens);
                nave = new Nave(context, teclado, imagens.nave, imagens.explosao);
                
                // Registramos os objetos entre si
                animacao.novoSprite(espaco);
                animacao.novoSprite(estrelas);
                animacao.novoSprite(nuvens);
                animacao.novoSprite(nave);
                
                // Registramos a nave como colisor
                colisor.novoSprite(nave);
                
                // Registramos o colisor nos processamentos
                animacao.novoProcessamento(colisor);
                
                // Chamamos as configurações iniciais
                configuracoesIniciais();
            }
            
            
            // Configurações iniciais do game
            function configuracoesIniciais() {
                // Configuramos os fundos
                espaco.velocidade = 60;
                estrelas.velocidade = 150;
                nuvens.velocidade = 500;
                
                // Configuramos e posicionamos a nave
                nave.x = canvas.width / 2 - 18; // nave: 36x48px (36 / 2 = 18)
                nave.y = canvas.height - 48 - 10;
                nave.velocidade = 250;
                
                // Criamos os inimigos
                criacaoInimigos();
                
                // Iniciamos a animacao
                // Desativada para não iniciar o game antes de clicar no botão
                //animacao.ligar();                
            }
            
            function criacaoInimigos() {
                criadorInimigos = {
                    ultimoOvni: new Date().getTime(),
                    
                    processar: function() {
                        var agora = new Date().getTime();
                        var decorrido = agora - this.ultimoOvni;
                        
                        // Caso ja tenha passado um segundo
                        if (decorrido > 1000) {
                            // Criamos outro inimigo
                            novoOvni();
                            // Setamos o ultimo criado como sendo o atual
                            this.ultimoOvni = agora;
                        }
                    }
                };
                
                // Registramos a criação de inimigos como
                // uma nova tarefa para a animação
                animacao.novoProcessamento(criadorInimigos);
            }
            
            function novoOvni() {
                // Capturamos a imagem do ovni
                var imgOvni = imagens.ovni;
                
                // Criamos um novo Ovni
                var ovni = new Ovni(context, imgOvni, imagens.explosao);
                
                // Definimos uma velocidade randomica para ele (entre 5 e 15)
                ovni.velocidade = Math.floor(Math.random() * (900 - 450 + 1));
                
                // Definimos a posição X que ele vai nascer
                ovni.x = Math.floor(Math.random() * (canvas.width - imgOvni.width + 1));
                
                // Descontamos a altura do Ovni para ele nascer escondido
                ovni.y = -imgOvni.height;
                
                // Registramos o inimigo na classe de animacao
                animacao.novoSprite(ovni);
                
                // Registramos o ovni como um colisor
                colisor.novoSprite(ovni);
            }
            
            // Função responsável por pausar jogo
            function pausarJogo() {
                if (animacao.ligado) {
                    // Desligamos a animação
                    animacao.desligar();
                    
                    // Desativamos os tiros
                    ativarTiro(false);
                    
                    // Mostramos uma mensagem de pausado na tela
                    context.save();
                    context.fillStyle = 'rgba(0, 0, 0, 0.4)';
                    context.fillRect(0, 0, canvas.width, canvas.height);
                    context.fillStyle = 'white';
                    context.strokeStyle = 'black';
                    context.font = '50px serif';
                    context.fillText("PAUSADO", 133, 260);
                    context.strokeText("PAUSADO", 133, 260);
                    context.restore();
                } else {
                    // Reiniciamos o tempo de criação do último Ovni
                    // para que um novo não nasça assim que despausarmos
                    criadorInimigos.ultimoOvni = new Date().getTime();
                    
                    // Ligamos a animação
                    animacao.ligar();
                    
                    // Ativamos os tiros
                    ativarTiro(true);
                }
            }
            
            // Função responsável pela configuração dos tiros
            function ativarTiro(ativar) {
                if (ativar) {
                    teclado.disparou(ESPACO, function() {
                        nave.atirar();
                    });
                } else {
                    teclado.disparou(ESPACO, null);
                }
            }
            
            // Função que carrega as músicas de fundo
            function carregarMusicas() {
                // Criamos o objeto de audio
                musicaFundo = new Audio();
                
                // Definimos o caminho do audio
                musicaFundo.src = 'assets/sounds/background-1.mp3';
                
                // Carregamos o arquivo
                musicaFundo.load();
                
                // Definimos o volume
                musicaFundo.volume = 0.5;
                
                // Definimos que o audio deve ficar em loop
                musicaFundo.loop = true;
            }
            
            // Função para controlar a música de fundo
            function controlarMusica(){
                if (musicaFundo.paused) musicaFundo.play();
                else musicaFundo.pause();
            }
            
            // Função para mostrar o link jogar na tela
            function mostrarLinkJogar() {
                document.getElementById('link_jogar').style.display = 'block';
            }
            
            // Função que inicia o jogo
            function iniciarJogo() {
                // Escondemos o botão de jogar
                document.getElementById('link_jogar').style.display = 'none';
                
                // Iniciamos a música de fundo
                musicaFundo.play();
                
                // Iniciamos a animação
                animacao.ligar();
                
                // Ativamos os tiros
                ativarTiro(true);
                
                // Configurações de pausa
                teclado.disparou(TECLA_P, pausarJogo);
                
                // Configurações do audio
                teclado.disparou(TECLA_S, controlarMusica);
            }
        </script>
    </body>
</html>